#!/bin/bash
# Created by Roel Van de Paar, MariaDB

RANDOM=`date +%s%N | cut -b14-19`  # Random entropy init
RANDF=$(echo $RANDOM$RANDOM$RANDOM$RANDOM | sed 's|.\(..........\).*|\1|')  # Random 10 digits filenr

gdb -q bin/mysqld $(ls data/*core*) >/tmp/${RANDF}.gdba 2>&1 << EOF
  set pagination off
  bt
  quit
EOF

echo '{noformat}'
cat ./in.sql
echo -e '{noformat}\n'
echo -e 'Leads to:\n'
# Assumes (which is valid for the pquery framework) that 1st assertion is also the last in the log
ERROR_LOG=$(ls log/master.err 2>/dev/null | head -n1)
if [ ! -z "${ERROR_LOG}" ]; then
  ASSERT="$(grep --binary-files=text -m1 'Assertion.*failed.$' ${ERROR_LOG} | head -n1)"
  if [ ! -z "${ASSERT}" ]; then
    echo -e "{noformat}\n${ASSERT}\n{noformat}\n"
  fi
fi
echo '{noformat}'
grep -A999 'Core was generated by' /tmp/${RANDF}.gdba | grep -v '^(gdb)[ \t]*$' | grep -v '^[0-9]\+.*No such file or directory.$' | sed 's|(gdb) (gdb) |(gdb) bt\n|'
echo -e '{noformat}\n'
if [ -r ../test.results ]; then
  cat ../test.results
fi
