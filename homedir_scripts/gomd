#!/bin/bash

BASEDIR=/test/MDEV-23536_MD080121-mariadb-10.6.0-linux-x86_64-dbg  # opt or dbg is fine, does not matter
#BASEDIR=/test/MD041220-mariadb-10.6.0-linux-x86_64-opt
#BASEDIR=/test/EMD021120-mariadb-10.5.6-4-linux-x86_64-dbg
RUNSOPT=2
RUNSDBG=2
#CONF=pquery-run-MD.conf  # File name only, no spaces, no directories
CONF=pquery-run-MD-buf.conf
#CONF=pquery-run-MD-rr.conf
#CONF=pquery-run-MD105-MT.conf
#CONF=pquery-run-MD105-ASAN.conf

echo "This script should show further output in 10-20 seconds. If it does not, see:"
echo "screen -d -r pr1  # for the cause"
echo ""

TOTALRUNS=$[ ${RUNSOPT} + ${RUNSDBG} ]
for RUN in $(seq 1 ${TOTALRUNS}); do
  rm -f /tmp/gomd_helper
  cd ~/mariadb-qa
  if [[ "${CONF}" == *"/"* ]]; then echo "Assert: no paths/directories allowed in CONF (${CONF}) setting!"; exit 1; fi
  if [ ! -r ${CONF} ]; then echo "Assert: ${CONF} not found!"; exit 1; fi
  sed -i "s|^BASEDIR=\([^#]\+\)|BASEDIR=${BASEDIR}   |" ${CONF}
  if [ ${RUN} -le ${RUNSOPT} ]; then  # Opt runs
    sed -i 's|^BASEDIR=\([^#]\+\)-dbg|BASEDIR=\1-opt|' ${CONF}
  else  # Dbg runs
    sed -i 's|^BASEDIR=\([^#]\+\)-opt|BASEDIR=\1-dbg|' ${CONF}
  fi
  screen -admS pr${RUN} bash -c "cd ~/mariadb-qa; ./pquery-run.sh ${CONF}; bash"
  while true; do
    sleep 1
    if [ -r /tmp/gomd_helper ]; then
      sleep 0.3
      DIR="$(cat /tmp/gomd_helper)"
      if [ -d "${DIR}" ]; then
        rm -f /tmp/gomd_helper
        cd ${DIR}/..
        DIREND="$(echo "${DIR}" | sed 's|.*/||')"
        if [ ! -d ./${DIREND} ]; then
          echo "Assert: ./${DIREND} should exist, based on directory passed by gomd_helper (${DIR})"
          exit 1; break
        else
          if [ ! -r ~/sge ]; then 
            echo "Assert: ~/sge not available! Cannot start pquery-go-expert!" 
            exit 1; break
          else
            ~/sge ${DIREND}
            TYPE="DBG"
            if [ ${RUN} -le ${RUNSOPT} ]; then TYPE="OPT"; fi
            echo "MD ${TYPE} Run ${RUN} started (Dir: ${DIR} Screen: pr${RUN}), and pquery-go-expert started for the same!"
            break
          fi
        fi 
      fi
    fi
  done
done
